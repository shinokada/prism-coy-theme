"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getBrokerUrl = void 0;
const resolve_pkg_1 = __importDefault(require("resolve-pkg"));
const upath_1 = __importDefault(require("upath"));
const url_1 = require("url");
const util_1 = require("./util");
function getBrokerUrl({ sourceIndex, outputSize, style, userStyle, singleDoc, quick, }) {
    let sourceUrl;
    if (util_1.isUrlString(sourceIndex)) {
        sourceUrl = new url_1.URL(sourceIndex);
    }
    else {
        sourceUrl = url_1.pathToFileURL(sourceIndex);
    }
    const viewerUrl = new url_1.URL('file://');
    viewerUrl.pathname = upath_1.default.join(resolve_pkg_1.default('@vivliostyle/viewer', { cwd: __dirname }), 'lib/index.html');
    const pageSizeValue = outputSize &&
        ('format' in outputSize
            ? outputSize.format
            : `${outputSize.width} ${outputSize.height}`);
    function escapeParam(url) {
        return url.replace(/&/g, '%26');
    }
    let viewerParams = `src=${escapeParam(sourceUrl.href)}&bookMode=${!singleDoc}&renderAllPages=${!quick}`;
    if (style) {
        viewerParams += `&style=${escapeParam(style)}`;
    }
    if (userStyle) {
        viewerParams += `&userStyle=${escapeParam(userStyle)}`;
    }
    if (pageSizeValue) {
        viewerParams +=
            '&userStyle=data:,/*<viewer>*/' +
                encodeURIComponent(`@page{size:${pageSizeValue}!important;}`) +
                '/*</viewer>*/';
    }
    return `${viewerUrl.href}#${viewerParams}`;
}
exports.getBrokerUrl = getBrokerUrl;
//# sourceMappingURL=server.js.map